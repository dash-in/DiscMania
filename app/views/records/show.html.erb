<div class="container">
  <div class="row">
    <div class="col-xs-4">
      <%= flash[:success] %>
      <h3>商品詳細</h3>
      <p>ジャンル：<br>
        <%= @record.genre %>
      </p>
      <%= attachment_image_tag @record, :image, format: 'jpeg', size: "200x200", fallback: "no_image.jpg", size:'200x200' %>
    </div>
    <div class="col-xs-8 space--1">
      <% if @record.stock > 0 %>
        <span class="label label-info">在庫あり</span>
      <% else %>
        <span class="label label-default">在庫なし</span>
      <% end %>

      <% if admin_signed_in? %>
        <p class="id">商品ID：
          <%= @record.id%>
        </p>
        <h2 class="title">
          <%= @record.name %>
        </h2>
        <p class="id">
          <%= @record.artist.name %>
        </p>
        <p class="maker">
          <%= @record.label %>
        </p>
        <h4 class="price">￥
          <%= number_with_delimiter (@record.price.to_i * @setting.tax).floor %>
        </h4>
        <p class="stock">在庫数</p>
          <%= form_for(@record, url: admin_record_path(@record),html:{method: "patch"}) do |f| %>
          <%= f.number_field :stock %>
        <%= f.submit "在庫数を更新する", class: "btn btn-primary" %>
        <% end %><br>
        <%= link_to '商品情報を編集する', edit_admin_record_path(@record), class: "btn btn-success bottun--1" %>
        <%= link_to 'この商品を削除する', admin_record_path(@record), class: 'btn btn-danger', method: :delete, "data-confirm" => "本当に削除しますか？" %>
        <%= link_to "logout", destroy_admin_session_path, method: :delete, class: 'glyphicon glyphicon-log-in' %>

      <% else %>
        <h2 class="title">
          <%= @record.name %>
        </h2>
        <p class="id">
          <%= @record.artist.name %>
        </p>
        <p class="maker">
          <%= @record.label %>
        </p>
        <h4 class="price">￥
         <%= number_with_delimiter (@record.price.to_i * @setting.tax).floor %>
        </h4>



        <!-- ここから新しいカート追加 -->
        <% stock_array= []
        @record.stock.times do |quantity|
          if quantity < 31
            stock_array.push(quantity)
          else
            break
          end %>
        <% end %>

        <% if user_signed_in? %>
        <% cart_item = CartItem.find_by(user_id:current_user.id, record_id:@record.id) %>
          <% if cart_item %>
            <%= form_for(cart_item, url: cart_item_path(cart_item),html:{method: "put"}) do |f| %>
            <%= f.select :quantity, stock_array %>
            <%= f.label :quantity, "個" %>
            <%= f.hidden_field :record_id, :value => @record.id %>
            <%= f.submit "カートに入れる", class:"btn btn-primary" %>
            <% end %>
          <% else %>
            <%= form_for @cart_item do |f| %>
            <%= f.select :quantity, stock_array %>
            <%= f.label :quantity, "個" %>
            <%= f.hidden_field :record_id, :value => @record.id %>
            <%= f.submit "カートに入れる", class:"btn btn-primary" %>
            <% end %>
          <% end %>
        <% else %>
          <%= form_for @cart_item do |f| %>
          <%= f.select :quantity, stock_array %>
          <%= f.label :quantity, "個" %>
          <%= f.hidden_field :record_id, :value => @record.id %>
          <%= f.submit "カートに入れる", class:"btn btn-primary" %>
          <% end %>
        <% end %>
      <% end %>
    </div>
  </div>

  <div class="row">
    <div class="col-xs-12">
      <h3>レコード詳細</h3>
      <p class="text">
        <%= simple_format(@record.body) %>
      </p>
    </div>
  </div>
  <div class="row">
    <h3>ソングリスト</h3>
      <% previous_disc_no = nil %>
      <% @record.tunes.each_with_index do |tune, i| %>
        <% if previous_disc_no != tune.disc_no %>
          <div class="col-xs-4">
            <h4 class="list-head">Disc<%= tune.disc_no %></h4>
        <% end %>
            <% previous_disc_no = tune.disc_no %>
            <p class="list">
              <%= tune.tune_order %>
              <%= tune.tune_name %>
            </p>
            <!-- もし、recordの曲が最後、または、曲のディスクナンバーと次の曲のディスクナンバーが一致しなかったとき -->
        <% if (i == @record.tunes.size - 1) || (tune.disc_no != @record.tunes[i+1].disc_no) %>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>
</div>
<br>
<br>
        <!-- ユーザーレビューは最後に実装します。 -->


        <style type="text/css">
          .user_review {
          padding:20px;
          }
        </style>

        <div class="user_review">
          <div class="review">
          <h3>ユーザーレビュー</h3>
            <table border width="100%" height="100%" style="table-layout:fixed;">
              <% @record.reviews.each do |review| %>
                <tr>
                  <td align="center" style="width:10%;"><%= attachment_image_tag @user, :image, format: 'jpeg', size: "80×80", fallback: "no_image.jpg", size:'50x50' %>
                  <td align="center" style="width:15%"><%= review.user.handlename %></td>
                  <td align="center"" style="width:10%"><%= review.created_at.strftime('%Y/%m/%d') %></td>
                </tr>
                <tr>
                  <td style="width:90%"; class="user_review" colspan="9" >
                    ＜レビュー＞<br>
                    <%= review.review %>
                  </td>
                  <% if user_signed_in? && current_user.id == review.user_id %>
                  <td class="botan" align="center" style="width:10%" colspan="2">
                    <%= link_to "編集", edit_record_review_path(@record.id,review.id), class:"btn btn-warning" %> <%= link_to "削除", record_review_path(@record.id, review.id), method: :delete, class:"btn btn-danger btn-primar" %>
                  </td>
                </tr>
              <% end %>
              <% end %>
            </table>

      <% if user_signed_in? %>
        <div class="new_review">
          <h3>レビューの投稿</h3>
           <div class="#">
             <%= form_for [@record, @review] do |f| %>
              <%= f.text_area :review, placeholder: "コメントをここに" %><br>
              <%= f.submit "送信する",class:"btn btn-danger left" %>
              <% end %>
            </div>
            <% end %>
           </div>
         </div>
        </div>