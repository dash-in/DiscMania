  <div class="container">
  <div class="row">
    <div class="col-xs-6">
      <%= flash[:success] %>
      <%= attachment_image_tag @record, :image, format: 'jpeg', size: "400x400", fallback: "no_image.jpg", size:'400x400' %>
    </div>
    <div class="col-xs-4 space--2">
      <% if @record.stock > 0 %>
        <span class="label label-info">在庫あり</span>
      <% else %>
        <span class="label label-default">在庫なし</span>
      <% end %>
        <h2 class="record_name">
          <b><%= @record.name %></b>
        </h2>
        <h2 class="artist_name">
          <%= @record.artist.name %>
        </h2>
        <p class="label">
          <%= @record.label %>
        </p>
        <h4 class="genre">
        ジャンル：<%= @record.genre %>
        </h4>
        <h4 class="price">￥
         <%= number_with_delimiter (@record.price.to_i * @setting.tax).floor %>
        </h4>

        <!-- ここから新しいカート追加 -->
        <% stock_array= []
        @record.stock.times do |quantity|
          if quantity < 30
            stock_array.push(quantity)
          else
            break
          end %>
        <% end %>

        <% if user_signed_in? %>
        <% cart_item = CartItem.find_by(user_id:current_user.id, record_id:@record.id) %>

          <% if cart_item %>
            <%= form_for(cart_item, url: cart_item_path(cart_item),html:{method: "put"}) do |f| %>
              <% if @record.stock == 0 %>
              <!-- login update -->
                <%= f.select :quantity, stock_array %>
                <%= f.label :quantity, "個" %>
                <%= f.hidden_field :record_id, :value => @record.id %>
                <%= f.submit "在庫がありません", class:"btn btn-warning" %>
              <% else %>
                <%= f.select :quantity, stock_array.push(stock_array.last.to_i + 1) %>
                <%= f.label :quantity, "個" %>
                <%= f.hidden_field :record_id, :value => @record.id %>
                <%= f.submit "カートに入れる", class:"btn btn-primary" %>
              <% end %>
            <% end %>
          <% else %>
          <!-- create login -->
            <%= form_for @cart_item do |f| %>
              <% if @record.stock == 0 %>
                <%= f.select :quantity, stock_array %>
                <%= f.label :quantity, "個" %>
                <%= f.hidden_field :record_id, :value => @record.id %>
                <%= f.submit "在庫がありません", class:"btn btn-warning" %>
              <% else %>
                <%= f.select :quantity, stock_array.push(stock_array.last.to_i + 1) %>
                <%= f.label :quantity, "個" %>
                <%= f.hidden_field :record_id, :value => @record.id %>
                <%= f.submit "カートに入れる", class:"btn btn-primary" %>
              <% end %>
            <% end %>
          <% end %>
        <% else %>
          <%= form_for @cart_item do |f| %>
            <% if @record.stock == 0 %>
              <%= f.select :quantity, stock_array %>
              <%= f.label :quantity, "個" %>
              <%= f.hidden_field :record_id, :value => @record.id %>
              <%= f.submit "在庫がありません", class:"btn btn-warning" %>
            <% else %>
              <%= f.select :quantity, stock_array.push(stock_array.last.to_i + 1) %>
              <%= f.label :quantity, "個" %>
              <%= f.hidden_field :record_id, :value => @record.id %>
              <%= f.submit "カートに入れる", class:"btn btn-primary" %>
            <% end %>
          <% end %>
        <% end %>
    </div>
  </div>

  <div class="row">
    <div class="col-xs-12">
      <h3>レコード詳細</h3>
      <p class="text">
        <%= simple_format(@record.body) %>
      </p>
    </div>
  </div>
  <div class="row">
    <h3>ソングリスト</h3>
      <% previous_disc_no = nil %>
      <% @record.tunes.each_with_index do |tune, i| %>
        <% if previous_disc_no != tune.disc_no %>
          <div class="col-xs-4">
            <h4 class="list-head">Disc<%= tune.disc_no %></h4>
        <% end %>
            <% previous_disc_no = tune.disc_no %>
            <p class="list">
              <%= tune.tune_order %>
              <%= tune.tune_name %>
            </p>
            <!-- もし、recordの曲が最後、または、曲のディスクナンバーと次の曲のディスクナンバーが一致しなかったとき -->
        <% if (i == @record.tunes.size - 1) || (tune.disc_no != @record.tunes[i+1].disc_no) %>
          </div>
        <% end %>
      <% end %>
    </div>
  </div>
</div>
<br>
<br>
        <!-- ユーザーレビューは最後に実装します。 -->


        <style type="text/css">
          .user_review {
          padding:20px;
          }
        </style>

<div class="user_review">
  <h3 class="review_titile">ユーザーレビュー</h3>
  <br>
  <div class="review">
    <% @record.reviews.each do |review| %>
        <div olspan="3" class="user_info">
          <%= attachment_image_tag @user, :image, format: 'jpeg', size: "80×80", fallback: "no_image.jpg", size:'50x50', class:"user_image" %>&emsp;&emsp;<%= review.user.handlename %>&emsp;&emsp;<%= review.created_at.strftime('%Y/%m/%d') %>
          <% if user_signed_in? && current_user.id == review.user_id %>&emsp;&emsp;
            <%= link_to "編集", edit_record_review_path(@record.id,review.id), class:"botan1" %>&emsp;
            <%= link_to "削除", record_review_path(@record.id, review.id), method: :delete %>
            <% end %>
        </div>
        <div class="review_post" >
          <%= review.review %>
        </div>
    <% end %>
  </div>
   <br>
    <% if user_signed_in? %>
      <div class="new_review">
        <h3>レビューの投稿</h3>
        <br>
         <div class="class="form-group"">
           <%= form_for [@record, @review] do |f| %>
            <%= f.text_area :review, placeholder: "コメントをここに" %><br>
            <%= f.submit "送信する",class:"btn-lg btn-danger" %>
     <% end %>
   </div>
  <% end %>
 </div>
</div>
</div>